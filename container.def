Bootstrap: docker
From: drikster80/vllm-aarch64-openai:v0.6.1

%files
    requirements.txt /opt/project/requirements.txt

%environment
    export VIRTUAL_ENV="/opt/project/.venv"
    export PATH="$VIRTUAL_ENV/bin:$PATH"
    export PATH="/root/.local/bin:$PATH"

%post
    echo "--> Installing build tools and uv..."
    apt-get update
    apt-get install -y build-essential python3-dev
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    curl -Ls https://astral.sh/uv/install.sh | bash
    mv /root/.local/bin/uv /usr/local/bin/uv
    mv /root/.local/bin/uvx /usr/local/bin/uvx

    echo "--> Setting up project directory..."
    mkdir -p /opt/project/fake_torch_package

    echo "--> Creating torch stub package..."
    cat <<EOF > /opt/project/fake_torch_package/pyproject.toml
[project]
name = "torch"
version = "2.4.0a0+3bcc3cddb5.nv24.07"
EOF

    # --- Create Virtual Environment ---
    echo "--> Creating virtual environment..."
    /root/.local/bin/uv venv /opt/project/.venv --system-site-packages

    # --- Install Dependencies Safely ---
    # Define the full path to the python executable in our new venv
    VENV_PYTHON="/opt/project/.venv/bin/python"

    echo "--> Installing torch stub into venv..."
    # Explicitly tell uv which python/venv to use for the installation.
    /root/.local/bin/uv pip install --python $VENV_PYTHON -e /opt/project/fake_torch_package

    echo "--> Installing dependencies from requirements.txt..."
    /root/.local/bin/uv pip install --python $VENV_PYTHON -r /opt/project/requirements.txt

    # --- Clean Up ---
    echo "--> Cleaning up build files..."
    rm -rf /opt/project/fake_torch_package

